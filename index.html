<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PREMIOS J&P 2025</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- LOGIN -->
<section id="login" class="seccion" style="display:none;">
  <h2>Iniciar sesi√≥n</h2>
  <div style="max-width:300px; margin:0 auto; text-align:center;">
    <input id="loginUser" type="text" placeholder="Usuario"
           style="width:100%; padding:8px; margin:8px 0;">
    <input id="loginPass" type="password" placeholder="Contrase√±a"
           style="width:100%; padding:8px; margin:8px 0;">
    <button id="btnLogin" class="btn gold" style="width:100%; padding:10px;">
      Entrar
    </button>
    <p id="loginError" style="color:red; display:none; margin-top:10px;">
      Usuario o contrase√±a incorrectos
    </p>
  </div>
</section>

<!-- CONTENIDO DE LA APP (oculto hasta login) -->
<div id="appContent" style="display:none;">

  <!-- NAV -->
  <nav class="top">
    <div class="nav-inner">
      <div class="logo">Josemari Awards 2025</div>
      <div class="nav-actions">
        <button class="btn" onclick="mostrarSeccion('inicio')">Inicio</button>
        <button class="btn" onclick="mostrarSeccion('participantes')">Participantes</button>
        <button class="btn" onclick="mostrarSeccion('categorias')">Categor√≠as</button>
        <button class="btn" onclick="mostrarSeccion('votacion')">Votar</button>
        <button class="btn" onclick="mostrarSeccion('votacion-nominados')">Votaci√≥n nominados</button>
        <button id="btnResultados" class="btn" onclick="mostrarSeccion('resultados')">Resultados</button>
      </div>

      <!-- PERFIL USUARIO -->
      <div id="perfilUsuario" class="perfil-usuario" style="display:none;">
        <span id="nombreUsuario"></span>
        <img id="avatarUsuario" src="" alt="Avatar"
             style="width:40px; height:40px; border-radius:50%; margin-left:8px; border:2px solid gold;">
      </div>
    </div>
  </nav>

  <!-- INICIO -->
  <header class="hero seccion" id="inicio">
    <div class="shine"></div>

    <!-- Columna izquierda -->
    <div class="fotos-lateral izquierda">
      <img src="fotos/Lagunas.png" alt="">
      <img src="fotos/Lodres.jpeg" alt="">
      <img src="fotos/Zurra.jpeg" alt="">
    </div>

    <div class="hero-inner">
      <div class="hero-texto">
        <span class="badge">JOSEMARI 2025</span>
        <h1>Bienvenido a los Premios Josemari 2025</h1>
        <p class="subtitle">Esta es la web oficial de los Premios de este a√±o ¬°Haz que tu voto cuente!</p>
        <div class="cta">
          <button class="btn gold" onclick="mostrarSeccion('votacion')">Votar ahora</button>
          <button class="btn" onclick="mostrarSeccion('participantes')">Ver participantes</button>
        </div>
      </div>

      <div class="hero-imagen">
        <img src="fotos/ImagenJosemari.png" alt="Imagen de inicio">
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="fotos-lateral derecha">
      <img src="fotos/fin_a√±o.jpeg" alt="">
      <img src="fotos/Playa.jpeg" alt="">
      <img src="fotos/Carnaval.jpeg" alt="">
    </div>
  </header>
</div>
  <script>
  // Usuarios v√°lidos
const usuariosPermitidos = {
  Asier: { pass: "claveAsier123", avatar: "fotos/asieras.jpeg" },
  Rulas: { pass: "claveRulas456", avatar: "fotos/rulas-avatar.png" },
  Raul:  { pass: "claveRaul789",  avatar: "fotos/raul-avatar.png" }
};
function mostrarPerfil(nombre) {
  document.getElementById("nombreUsuario").textContent = nombre;
  document.getElementById("avatarUsuario").src = usuariosPermitidos[nombre].avatar;
  document.getElementById("perfilUsuario").style.display = "flex";
}

document.getElementById("perfilUsuario").addEventListener("click", () => {
  if (confirm("¬øCerrar sesi√≥n?")) {
    localStorage.removeItem("usuarioLogueado");
    document.getElementById("perfilUsuario").style.display = "none";

    // üëá oculta todo el contenido y vuelve a mostrar el login
    document.getElementById("appContent").style.display = "none";
    document.getElementById("login").style.display = "block";
  }
});


  // Mostrar u ocultar bot√≥n Resultados seg√∫n usuario
  function controlarAccesoResultados() {
    const user = localStorage.getItem("usuarioLogueado");
    const btn = document.getElementById("btnResultados");
    if (btn) btn.style.display = ["Asier","Rulas"].includes(user) ? "" : "none";
  }

  // Navegaci√≥n entre secciones
  function mostrarSeccion(seccion) {
    const necesitaLogin = !["login","inicio","participantes","categorias"].includes(seccion);
    const user = localStorage.getItem("usuarioLogueado");
    if (necesitaLogin && !user) seccion = "login";

    document.querySelectorAll(".seccion").forEach(s => s.style.display = "none");
    document.getElementById(seccion).style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });

    if (seccion === "login") {
      document.getElementById("loginError").style.display = "none";
      document.getElementById("loginUser").value = "";
      document.getElementById("loginPass").value = "";
    }
    if (seccion === "resultados") cargarResultados();
  }

  // Login
  document.getElementById("btnLogin").addEventListener("click", () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
if (usuariosPermitidos[user] && usuariosPermitidos[user].pass === pass) {
  localStorage.setItem("usuarioLogueado", user);
  mostrarPerfil(user);
  controlarAccesoResultados();

  // üëá aqu√≠ ocultamos login y mostramos la app
  document.getElementById("login").style.display = "none";
  document.getElementById("appContent").style.display = "block";

  mostrarSeccion("inicio");
} else {
  document.getElementById("loginError").style.display = "block";
}



  });

// =========================
// SESI√ìN RECORDADA
// =========================
window.addEventListener("DOMContentLoaded", async () => {
  const user = localStorage.getItem("usuarioLogueado");
  if (user && usuariosPermitidos[user]) {
    mostrarPerfil(user);
    controlarAccesoResultados();
    document.getElementById("login").style.display = "none";
    document.getElementById("appContent").style.display = "block";
    mostrarSeccion("inicio");

    if (window.actualizarEstadoBotonNominaciones) {
      await window.actualizarEstadoBotonNominaciones();
    }
  } else {
    document.getElementById("login").style.display = "block";
    document.getElementById("appContent").style.display = "none";
  }
});



</script>


  <main>
    <!-- PARTICIPANTES -->
    <section id="participantes" class="seccion">
      <h2>Participantes</h2>
      <div class="grid-participantes">
        <div class="participante"><img src="fotos/asieras.jpeg" alt="Asieras"><h3>Asieras</h3></div>
        <div class="participante"><img src="fotos/rulillas.jpeg" alt="Rulillas"><h3>Rulillas</h3></div>
        <div class="participante"><img src="fotos/dario.jpeg" alt="Darawayas"><h3>Darawayas</h3></div>
        <div class="participante"><img src="fotos/ivanp.jpeg" alt="Ivanpechotes"><h3>Ivanpechotes</h3></div>
        <div class="participante"><img src="fotos/dani.jpeg" alt="Danigg"><h3>DaniGG</h3></div>
        <div class="participante"><img src="fotos/Lucia.jpeg" alt="Lusilu"><h3>Lusilu</h3></div>
        <div class="participante"><img src="fotos/ines.jpeg" alt="Almansa"><h3>Almansa</h3></div>
        <div class="participante"><img src="fotos/rober.jpeg" alt="Robertuki"><h3>Robertuki</h3></div>
        <div class="participante"><img src="fotos/marco.jpeg" alt="To√±aco"><h3>To√±aco</h3></div>
        <div class="participante"><img src="fotos/manu.jpeg" alt="Manolo"><h3>Manolo</h3></div>
        <div class="participante"><img src="fotos/mario.jpeg" alt="Kastor"><h3>Kastor</h3></div>
        <div class="participante"><img src="fotos/maria.jpeg" alt="Maria"><h3>Maria</h3></div>
        <div class="participante"><img src="fotos/gamepro.jpeg" alt="Gamepro"><h3>Gamepro</h3></div>
        <div class="participante"><img src="fotos/fervico.jpeg" alt="El Enano"><h3>El Enano</h3></div>
        <div class="participante"><img src="fotos/Poru.jpeg" alt="Poru"><h3>Poru</h3></div>
        <div class="participante"><img src="fotos/iker.jpeg" alt="Ikardo"><h3>Ikardo</h3></div>
        <div class="participante"><img src="fotos/Fermoriv.jpeg" alt="Fermoriv"><h3>Fermoriv</h3></div>
        <div class="participante"><img src="fotos/labrada.jpeg" alt="Lab el Viejo"><h3>Lab el Viejo</h3></div>
<!-- Modal para mostrar participante -->
</div>
</section>

  

<!-- Modal fuera de la secci√≥n -->
<div id="modalParticipante" class="modal">
    <div class="modal-contenido">
      <span class="cerrar">&times;</span>
      <div class="modal-body">
        <img id="modalImagen" src="" alt="">
        <div class="modal-texto">
          <p id="modalDescripcion"></p>
        </div>
      </div>
    </div>
  </div>
  <!-- Lightbox de v√≠deo -->
<div id="videoLightbox" class="video-modal" hidden>
  <div class="video-modal__inner">
    <button class="video-modal__close" aria-label="Cerrar">&times;</button>
    <video id="lightboxVideo" controls playsinline></video>
  </div>
</div>



<!-- CATEGOR√çAS -->
<section id="categorias" class="seccion">
  <h2>Categor√≠as</h2>
  <div class="grid-participantes">
    <div class="categoria" data-descripcion="Boracho del A√±o: La persona que mas se ha puesto hasta el culo en todo el a√±o, nose si tanto como en la foto porque vaya cogorza lleva mi colegon el reparte melones, asi da gusto, esta categoria es para los valientes y para los que le echan cojones ostia">
      <img src="fotos/borracho.jpeg" alt="Borracho del a√±o">
      <h3> Borracho del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Fiestero del A√±o: ¬°Siempre listo para la fiesta! Donde hay m√∫sica y diversi√≥n, ah√≠ est√° √©l/ella, contagiando alegr√≠a y buena vibra a todos">
      <img src="fotos/fiestero.jpeg" alt="Fiestero del a√±o">
      <h3> Fiestero del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Video del A√±o: Ese clip que todos vimos mil veces, que nos hizo re√≠r, sorprendernos o simplemente recordar un momento √©pico. ¬°Imposible olvidarlo!">
      <img src="fotos/viajero.jpeg" alt="Viejero del a√±o">
      <h3> Viejero del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Palabras del A√±o: La palabra perfecta, el comentario m√°s √©pico o el dicho que todos recuerdan. ¬°Lo que hace historia!">
      <img src="fotos/palabra.jpeg" alt="Palabra del a√±o">
      <h3> Palabra/Frase del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Tr√≠o del A√±o: Ese grupo inseparable que siempre est√° junto, causando risas, travesuras y momentos inolvidables. ¬°Tres veces m√°s diversi√≥n!">
      <img src="fotos/trio.jpeg" alt="trio del a√±o">
      <h3> Trio del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Mejor Personaje fuera de JYP: Esa persona fuera del grupo que brilla por su estilo √∫nico y carisma, dejando huella all√° donde va. ¬°Imposible no recordarla">
      <img src="fotos/mpersonaje.jpeg" alt="Mejor Personaje fuera de JyP">
      <h3> Mejor Personaje fuera de JyP</h3>
    </div>
    <div class="categoria" data-descripcion="Fiesta del A√±o: La celebraci√≥n que nadie quiere perderse: m√∫sica, risas y momentos √©picos garantizados. ¬°Memorable de principio a fin!">
      <img src="fotos/fiesta.jpeg" alt="Fiesta del a√±o">
      <h3> Fiesta del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Autistada del A√±o: Esa persona que destaca por su intensidad, originalidad y pasi√≥n en hacer la mayor autistada del a√±o. ¬°Siempre dejando su marca √∫nica!">
      <img src="fotos/autistada.jpg" alt="Autistada del a√±o">
      <h3> Autistada del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Broma del A√±o: Ese momento que nos hizo re√≠r hasta doler la panza y que todos recordaremos por siempre. ¬°Risas garantizadas!">
      <img src="fotos/broma.jpeg" alt="Broma del a√±o">
      <h3> Broma del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Foto del A√±o: La captura que lo dice todo: momentos √©picos, caras inolvidables y pura vibra. ¬°Inmortalizada para la historia!">
      <img src="fotos/foto.jpeg" alt="Foto del a√±o">
      <h3> Foto del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Video del A√±o: Ese clip que todos vimos mil veces, que nos hizo re√≠r, sorprendernos o simplemente recordar un momento √©pico. ¬°Imposible olvidarlo!">
      <img src="fotos/video.jpeg" alt="Video del a√±o">
      <h3> Video del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Mote del A√±o: Ese apodo que se qued√≥ pegado, nos hizo re√≠r y define a la perfecci√≥n a su due√±o. ¬°Imposible no llamarlo as√≠!">
      <img src="fotos/mote.jpeg" alt="Mote del a√±o">
      <h3> Mote del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="M√°s Guarro: Esa persona que no tiene filtros, dice lo que piensa y vive la vida sin verg√ºenza. ¬°Sin miedo y sin censura!">
      <img src="fotos/guarrete.jpeg" alt="Guarrete del a√±o">
      <h3> Guarrete del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Fail del A√±o: Ese momento √©pico que sali√≥ todo mal‚Ä¶ pero nos hizo re√≠r a carcajadas. ¬°Un cl√°sico que nunca olvidaremos!">
      <img src="fotos/fail.jpeg" alt="Fail del a√±o">
      <h3> Fail del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Mejor Momento del A√±o: Ese instante que nos hizo sonre√≠r, celebrar o simplemente sentir que todo vali√≥ la pena. ¬°Pura magia!">
      <img src="fotos/m_momento.jpeg" alt="Mejor Momento del a√±o">
      <h3> Mejor momento del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Meme del A√±o: Ese momento convertido en imagen que nos hizo re√≠r una y otra vez. ¬°Imposible olvidarlo!">
      <img src="fotos/meme.jpeg" alt="Meme del a√±o">
      <h3> Meme del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Braihot del A√±o: Esa persona que siempre sorprende con ideas locas, ocurrencias √©picas y creatividad sin l√≠mites. ¬°Pura genialidad rebelde!">
      <img src="fotos/brainhot.jpeg" alt="Braihot del a√±o">
      <h3> Braihot del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Correa del A√±o: La persona que siempre quiere hacer de todo‚Ä¶ pero su pareja no la deja ni respirar">
      <img src="fotos/correon.jpeg" alt="Correon del a√±o">
      <h3> Correon del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Objeto del A√±o: Ese accesorio o cosa que se volvi√≥ protagonista, usado, recordado o mencionado por todos. ¬°El verdadero √≠cono del grupo!">
      <img src="fotos/objeto.jpg" alt="Objeto del a√±o">
      <h3> Objeto del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Loco del A√±o: Esa persona que siempre rompe esquemas con ocurrencias inesperadas, locuras √©picas y energ√≠a sin fin. ¬°Nunca sabes qu√© esperar!">
      <img src="fotos/loco.jpg" alt="Loco del a√±o">
      <h3> Loco del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Mejor Vestido del A√±o: Siempre con estilo impecable, marcando tendencia y rob√°ndose miradas. ¬°El icono fashion del grupo!">
      <img src="fotos/mejorviste.jpeg" alt="El que mejor viste del a√±o">
      <h3> El que mejor viste del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Peor Momento del A√±o: Ese instante que todos quisimos borrar, pero que termin√≥ siendo parte de la historia.">
      <img src="fotos/p_momento.jpeg" alt="Peor momento del a√±o">
      <h3> Peor momento del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Papi/Mami del A√±o: La persona que se preocupa por todos, cuida, aconseja y siempre est√° al pendiente del grupo. ¬°Nuestro √°ngel guardi√°n">
      <img src="fotos/papi.jpg" alt="Papi/Mami del a√±o">
      <h3> Papi/Mami del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Competitivo del A√±o: Siempre buscando ganar en todo, desde juegos hasta bromas. ¬°No conoce la palabra rendirse!">
      <img src="fotos/competititivo.png" alt="Competitivo del a√±o">
      <h3> Competitivo del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Mensaje del A√±o: Ese chat que se volvi√≥ legendario, ya sea por hacerlo re√≠r, sorprender o quedar grabado en la memoria del grupo.">
      <img src="fotos/mensaje.jpeg" alt="Mensaje del a√±o">
      <h3> Mensaje del a√±o</h3>
    </div>
    <div class="categoria" data-descripcion="Premio a la persona m√°s divertida.">
      <img src="fotos/soltero.jpeg" alt="Solteros del a√±o">
      <h3> Soltero del a√±o</h3>
    </div>    <div class="categoria" data-descripcion="Premio a la persona m√°s bailonga.">
      <img src="fotos/Baile.jpeg" alt="Baile del a√±o">
      <h3> Baile del a√±o</h3>
    </div>    <div class="categoria" data-descripcion="Decepci√≥n del A√±o: Esa persona que nos fall√≥ o nos sorprendi√≥ para mal, dej√°ndonos con cara de ‚Äúno me lo esperaba‚Äù.">
      <img src="fotos/decepcion.jpeg" alt="Decepci√≥n del a√±o">
      <h3> Decepci√≥n del a√±o</h3>
    </div>    <div class="categoria" data-descripcion="Revelaci√≥n del A√±o: Esa persona que sorprendi√≥ a todos con su talento, carisma o estilo. ¬°Nadie la vio venir y ahora todos hablan de ella!">
      <img src="fotos/revelacion.png" alt="Revelaci√≥n del a√±o">
      <h3> Revelaci√≥n del a√±o</h3>
    </div>    <div class="categoria" data-descripcion="MVP: La persona que se lleva todos los aplausos, siempre destacando y dejando huella. ¬°Imparable y digno de ovaci√≥n!">
      <img src="fotos/mvp.png" alt="MVP del a√±o">
      <h3> MVP del a√±o</h3>
    </div>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.grid-nominados video').forEach(v => {
    v.controls = true;
    v.muted = true;
    v.setAttribute('playsinline','');
    v.setAttribute('webkit-playsinline','');
    v.setAttribute('preload','metadata');
  });
});
</script>

<!-- Modal para mostrar categor√≠a -->
<div id="modalCategoria" class="modal">
  <div class="modal-contenido">
    <span class="cerrar">&times;</span>
    <div class="modal-body">
      <img id="modalImagenCategoria" src="" alt="">
      <div class="modal-texto">
        <p id="modalDescripcionCategoria"></p>
      </div>
    </div>
  </div>
</div>


    <!-- VOTACI√ìN -->
    <section id="votacion" class="seccion" style="display:none;">
      <div style="padding:50px; text-align:center; font-size:1.5em; font-weight:bold;">
        üöß Esta parte a√∫n no est√° disponible.  
        <br>¬°Pronto podr√°s votar aqu√≠!
      </div>
    </section>
    
    <section id="votacion" class="seccion">
      <h2>Votaci√≥n</h2>
      <p>Selecciona tus nominados y pulsa ‚ÄúVOTAR‚Äù.</p>

      <div class="categoria">
        <h3>Mejor amigo</h3>
        <button class="voto" data-categoria="Mejor amigo" data-nominado="Asieras">Asieras</button>
        <button class="voto" data-categoria="Mejor amigo" data-nominado="Rulillas">Rulillas</button>
        <button class="voto" data-categoria="Mejor amigo" data-nominado="Darawayas">Darawayas</button>
      </div>

      <div class="categoria">
        <h3>M√°s divertido</h3>
        <button class="voto" data-categoria="M√°s divertido" data-nominado="Asieras">Asieras</button>
        <button class="voto" data-categoria="M√°s divertido" data-nominado="Rulillas">Rulillas</button>
        <button class="voto" data-categoria="M√°s divertido" data-nominado="Darawayas">Darawayas</button>
      </div>

      <div class="categoria">
        <h3>M√°s creativo</h3>
        <button class="voto" data-categoria="M√°s creativo" data-nominado="Asieras">Asieras</button>
        <button class="voto" data-categoria="M√°s creativo" data-nominado="Rulillas">Rulillas</button>
        <button class="voto" data-categoria="M√°s creativo" data-nominado="Darawayas">Darawayas</button>
      </div>

      <button id="enviarVoto" class="btn gold">VOTAR</button>
    </section>

<section id="votacion-nominados" class="seccion" style="display:none;">
  <div id="nominadosWrapper"></div>
  <button id="enviarTodasNominaciones" class="btn gold">Enviar todas las nominaciones</button>
</section>

    
<section id="resultados" class="seccion" style="display:none;">
  <h2>Resultados de las votaciones</h2>

  <!-- üëá Sin login; mostramos directamente el contenido -->
  <div id="resultados-contenido" style="display:block;">
    <h3>Resultados por categor√≠a</h3>
    <div id="tabla-resultados"></div>

    <!-- Botones de gesti√≥n -->
    <button id="borrarVotos" class="btn red" style="margin-top:15px;">Borrar todos los votos</button>
    <button id="borrarNominaciones" class="btn red" style="margin-top:15px;">Borrar todas las nominaciones</button>
    <button id="restaurarVotaciones" class="btn gold" style="margin-top:15px;">Restaurar votaciones</button>
  </div>
</section>

    

    
  </main>

  
  <footer>
    ¬© Premios Josemari 2025 ‚Äî Hecho por Iceman.
  </footer>

  

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where,
  getDoc, setDoc, updateDoc, doc, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";


    
    const firebaseConfig = {
      apiKey: "AIzaSyBNfmxGA8GNgWf-N1sstPhQlWitYMjnd6M",
      authDomain: "premiosjosemari-bc894.firebaseapp.com",
      projectId: "premiosjosemari-bc894",
      storageBucket: "premiosjosemari-bc894.appspot.com",
      messagingSenderId: "118315358578",
      appId: "1:118315358578:web:4c6c2248fdbdd4f61e65eb"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    function safeIdPart(str) {
  // Firestore no admite "/" en los IDs de documento; adem√°s dejamos robusto
  return encodeURIComponent(String(str).replaceAll('/', '_'));
}

    
// ===== Ciclo global de votaciones (no borra nada; abre nueva ronda) =====
const CONFIG_DOC = doc(db, "config", "estado");

async function getCicloActual() {
  const snap = await getDoc(CONFIG_DOC);
  if (!snap.exists()) {
    await setDoc(CONFIG_DOC, { ciclo: 1 });
    return 1;
  }
  const data = snap.data();
  return typeof data.ciclo === "number" ? data.ciclo : 1;
}

async function aumentarCiclo() {
  const ciclo = await getCicloActual();
  try {
    await updateDoc(CONFIG_DOC, { ciclo: ciclo + 1 });
  } catch {
    await setDoc(CONFIG_DOC, { ciclo: ciclo + 1 });
  }
  return ciclo + 1;
}


    

// =========================
// CAMBIO DE SECCI√ìN (√∫nica)
// =========================
window.mostrarSeccion = async function (seccion) {
  // Si la secci√≥n requiere login y no hay usuario, manda a login
  const necesitaLogin = !["login","inicio","participantes","categorias"].includes(seccion);
  const user = localStorage.getItem("usuarioLogueado");
  if (necesitaLogin && !user) seccion = "login";

  document.querySelectorAll('.seccion').forEach(sec => sec.style.display = 'none');
  const destino = document.getElementById(seccion);
  if (destino) destino.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });

  if (seccion === 'votacion-nominados') {
    // Limpiar contenedores y volver a crear (evita duplicados)
renderNominadosPorLotes();

if (window.actualizarEstadoBotonNominaciones) {
  await window.actualizarEstadoBotonNominaciones();
}

// Cabeceras con imagen (se re-aplican cada vez)
if (typeof enhanceCategoryHeaders === 'function') {
  enhanceCategoryHeaders();
}


  }

  if (seccion === "resultados" && typeof cargarResultados === "function") {
    cargarResultados();
  }
};

// ===== Cabeceras con imagen =====
// fallback si no pones imagen para una categor√≠a
const DEFAULT_PLACA = "fotos/placa-default.png";

// A√±ade aqu√≠ las rutas que quieras; si falta alguna usar√° DEFAULT_PLACA
const categoryImages = {
  // Lote 1
  "Fiestero/a del a√±o": "fotos/fiestero.png",
  "Borrach@ del a√±o":   "fotos/borracho.png",
  "M√°s guarr@ del a√±o": "fotos/guarrete.png",
  "Viajero/a":          "fotos/viajero.jpg",
  "Otra categor√≠a":     "fotos/otra.jpg",

  // Lote 2
  "Broma del a√±o":             "fotos/broma.png",
  "Foto del a√±o":              "fotos/foto.png",
  "Mejor momento del a√±o":     "fotos/m.png",
  "Meme del a√±o":              "fotos/meme.jpg",
  "Objeto del a√±o":            "fotos/objeto.jpg",

  // Lote 3
  "Tr√≠o del a√±o":                    "fotos/trio.jpg",
  "Mejor Personaje fuera de JyP":    "fotos/mpersonaje.jpg",
  "Fiesta del a√±o":                  "fotos/fiesta.jpg",
  "Autistada del a√±o":               "fotos/autistada.png",
  "Fail del a√±o":                    "fotos/fail.jpg",

  // Lote 4
  "Mensaje del a√±o":             "fotos/mensaje.jpeg",
  "Competitivo del a√±o":         "fotos/competitivo.png",
  "Peor momento del a√±o":        "fotos/peor_m.png",
  "Papi/Mami del a√±o":           "fotos/papi.jpg",
  "El que mejor viste del a√±o":  "fotos/mejorviste.png",

  // Lote 5
  "Loco del a√±o":          "fotos/loco.jpg",
  "Mote del a√±o":          "fotos/mote.png",
  "Revelaci√≥n del a√±o":    "fotos/revelacion.png",
  "Decepci√≥n del a√±o":     "fotos/decepcion.jpg",
  "MVP del a√±o":           "fotos/mvp.png",

  // Lote 6
  "Video del a√±o":                "fotos/video.jpg",
  "Palabra/Frase del a√±o":       "fotos/palabra.jpeg",
  "Correa del a√±o":              "fotos/correon.png",
  "Braihot del a√±o":             "fotos/braihot.jpg",
  "Objeto del a√±o (edici√≥n especial)": "fotos/objeto.jpg"
};

function enhanceCategoryHeaders() {
  const wrap = document.getElementById('nominadosWrapper');
  if (!wrap) return;

  // para poder re-ejecutar cada vez
  delete wrap.dataset.headersEnhanced;
  if (wrap.dataset.headersEnhanced === "1") return;

  wrap.querySelectorAll(':scope > h2').forEach(h2 => {
    const titulo = h2.textContent.trim();
    if (h2.closest('.cat-header')) return;

    const imgSrc = categoryImages[titulo] || DEFAULT_PLACA;
    const p = h2.nextElementSibling && h2.nextElementSibling.tagName === "P"
      ? h2.nextElementSibling : null;

    const header = document.createElement('div');
    header.className = 'cat-header';

    const img = document.createElement('img');
    img.className = 'cat-badge';
    img.src = imgSrc;
    img.alt = titulo;

    const wrapTitle = document.createElement('div');
    wrapTitle.className = 'title-group';
    wrapTitle.appendChild(h2.cloneNode(true));
    if (p) wrapTitle.appendChild(p.cloneNode(true));

    header.appendChild(img);
    header.appendChild(wrapTitle);

    h2.parentNode.insertBefore(header, h2);
    if (p) p.remove();
    h2.remove();
  });

  wrap.dataset.headersEnhanced = "1";
}

    
    // =========================
    // VOTACI√ìN NORMAL
    // =========================
    const votosSeleccionados = {};
    document.querySelectorAll('.voto').forEach(btn => {
      btn.addEventListener('click', () => {
        const categoria = btn.dataset.categoria;
        const nominado = btn.dataset.nominado;
        votosSeleccionados[categoria] = nominado;
    
        document.querySelectorAll(`.voto[data-categoria="${categoria}"]`)
          .forEach(b => b.classList.remove('selected'));
    
        btn.classList.add('selected');
      });
    });
    
    const enviarBtn = document.getElementById('enviarVoto');
    if (enviarBtn) {
      enviarBtn.addEventListener('click', async () => {
        const categorias = ["Mejor amigo", "M√°s divertido", "M√°s creativo"];
        for (let cat of categorias) {
          if (!votosSeleccionados[cat]) {
            alert(`Debes seleccionar un participante para "${cat}"`);
            return;
          }
        }
        try {
          enviarBtn.disabled = true;
          for (let cat of categorias) {
async function guardarVoto(categoria, opcionElegida) {
  const usuario = localStorage.getItem("usuarioLogueado"); // üëà qui√©n est√° logueado
  await addDoc(collection(db, "votaciones"), {
    usuario: usuario,
    categoria: categoria,
    voto: opcionElegida,
    timestamp: serverTimestamp()
  });
  async function votar(categoria, opcionElegida) {
  const usuario = localStorage.getItem("usuarioLogueado");

  // 1) Comprobar si ya vot√≥ este usuario en esta categor√≠a
  const q = query(
    collection(db, "votaciones"),
    where("usuario", "==", usuario),
    where("categoria", "==", categoria)
  );
  const snapshot = await getDocs(q);

  if (!snapshot.empty) {
    alert("Ya has votado en esta categor√≠a");
    return;
  }

  // 2) Guardar el voto
  await guardarVoto(categoria, opcionElegida);
  alert("Voto registrado correctamente");
}

}


          }
          alert("¬°Tus votos han sido registrados!");
          localStorage.removeItem("usuario");
          location.reload();
        } catch (e) {
          console.error("Error guardando votos: ", e);
          alert("Hubo un error al guardar tus votos.");
        } finally {
          enviarBtn.disabled = false;
        }
      });
    }
    // === NOMINADOS ESPECIALES POR CATEGOR√çA ===
// Si una categor√≠a aparece aqu√≠, usar√° ESTOS nominados en vez de los del grid #participantes
const NOMINADOS_ESPECIALES = {
  "Personaje del a√±o": [
    { nombre: "Pepito", foto: "fotos/especiales/pepito.jpg" },
    { nombre: "Menganita", foto: "fotos/especiales/menganita.jpg" },
    { nombre: "El del bar", foto: "fotos/especiales/bar.jpg" },
    { nombre: "La profe", foto: "fotos/especiales/profe.jpg" },
    { nombre: "Vecino 3¬∫B", foto: "fotos/especiales/vecino.jpg" }
  ],

  "Mejor Personaje fuera de JyP del a√±o": [
    { nombre: "Diegote", foto: "fotos/perosnajes/diego.jpeg" },
    { nombre: "Iceman", foto: "fotos/perosnajes/iceman.jpeg" },
    { nombre: "B√≥lido", foto: "fotos/perosnajes/bolido.jpeg" },
    { nombre: "Cangur√≠n", foto: "fotos/perosnajes/cangurin.jpeg" },
    { nombre: "Unai el guay", foto: "fotos/perosnajes/unai.jpeg" },
    { nombre: "Javichu", foto: "fotos/perosnajes/javichu.jpeg" },
    { nombre: "Mariodi", foto: "fotos/perosnajes/mariodi.jpeg" },
    { nombre: "Juan Noblejas", foto: "fotos/perosnajes/juan.jpeg" },
    { nombre: "Pepito", foto: "fotos/perosnajes/pepito.jpeg" },
    { nombre: "Nuria", foto: "fotos/perosnajes/nuria.jpeg" }
  ],

    "Fiesta del a√±o": [
    { nombre: "Factory de Enero", foto: "fotos/fiesta/factory.jpeg" },
    { nombre: "Carnavales", foto: "fotos/fiesta/carnaval.jpeg" },
    { nombre: "Feria de Abril", foto: "fotos/fiesta/abril.jpeg" },
    { nombre: "Magma", foto: "fotos/fiesta/magma.jpeg" },
    { nombre: "Proyecto x", foto: "fotos/fiesta/proyecto x.jpeg" },
    { nombre: "Zurra", foto: "fotos/fiesta/zurra.jpeg" },
    { nombre: "Pandorga", foto: "fotos/fiesta/pandorga.jpeg" },
    { nombre: "Ferias Peruanas", foto: "fotos/fiesta/peruana.jpeg" },
    { nombre: "Ferias de Ciu", foto: "fotos/fiesta/ciu.jpeg" },
    { nombre: "Hallowen?¬ø?¬ø", foto: "fotos/fiesta/.jpeg" },
  ],

      "Objeto del a√±o": [
    { nombre: "Tequifresi", foto: "fotos/objeto/tequifresi.jpeg" },
    { nombre: "Cia", foto: "fotos/objeto/cia.jpeg" },
    { nombre: "Shisha X", foto: "fotos/objeto/sisa.jpeg" },
    { nombre: "Pelusa", foto: "fotos/objeto/pelusa.jpeg" },
    { nombre: "Bandera Peruana ", foto: "fotos/objeto/peruana.jpeg" },
    { nombre: "Ana Rosa", foto: "fotos/objeto/anarosa.jpeg" },
    { nombre: "Ositopro", foto: "fotos/objeto/ositopro.jpeg" },
    { nombre: "Pantalones Bob esponja", foto: "fotos/objeto/pantalonesb.jpeg" },
    { nombre: "Salami", foto: "fotos/objeto/salami.png" },
    { nombre: "Nunca Follo", foto: "fotos/objeto/follo.jpeg" },
  ],

        "Palabra/Frase del a√±o": [
    { nombre: "Sirulo", foto: "fotos/palabra/sirulo.jpeg" },
    { nombre: "Esa pe√±aaaa", foto: "fotos/palabra/pe√±a.jpeg" },
    { nombre: "Vamos no me jodas", foto: "fotos/palabra/vamos.jpeg" },
    { nombre: "Subnormal!", foto: "fotos/palabra/subnormal.jpeg" },
    { nombre: "Tengo miedo a que se me caigan las patatas", foto: "fotos/palabra/patatas.jpeg" },
    { nombre: "Bomba", foto: "fotos/palabra/bomba.jpeg" },
    { nombre: "Virgen", foto: "fotos/palabra/virgen.jpeg" },
    { nombre: "Prohibido divieto ", foto: "fotos/palabra/prohibido.jpeg" },
    { nombre: "Que si que vamso a por ti ", foto: "fotos/palabra/vamosti.jpeg" },
    { nombre: "Yets", foto: "fotos/palabra/yets.jpeg" },
  ],
"Video del a√±o": [
  { nombre: "La correa de mi primo", video: "videos/correa.mp4", poster: "fotos/fail.jpeg" },
  { nombre: "Proyecto X", video: "videos/proyecto_x.mp4", poster: "fotos/posters/proyecto_x.jpg" },
  { nombre: "Feria Abril", video: "videos/feria_abril.mp4", poster: "fotos/posters/feria_abril.jpg" }
]

};

// (Opcional) M√°ximo por categor√≠a (si alguna NO es 3)
const MAX_SELECCION_POR_CATEGORIA = {
  // "Personaje del a√±o": 1,
  // "Tr√≠o del a√±o": 3,
};

// =========================
// NOMINACIONES POR USUARIO
// =========================
const nominacionesPorCategoria = {};

function crearApartadoNominaciones(idLista, categoriaNombre) {
  const contenedor = document.getElementById(idLista);
  nominacionesPorCategoria[categoriaNombre] = [];

  // 1) ¬øTiene nominados especiales?
  const override = NOMINADOS_ESPECIALES[categoriaNombre];
  let lista = [];

if (Array.isArray(override) && override.length) {
  // Usar especiales (conservar video y poster)
  lista = override.map(o => ({
    nombre: o.nombre,
    foto:   o.foto ?? null,
    video:  o.video ?? null,
    poster: o.poster ?? null
  }));
  } else {
    // Usar participantes del grid como hasta ahora
    document.querySelectorAll('#participantes .participante').forEach(part => {
      const nombre = part.querySelector('h3').innerText.trim();
      const foto = part.querySelector('img').src;
      lista.push({ nombre, foto });
    });
  }

// 2) Pintar tarjetas (con soporte de v√≠deo)
lista.forEach(item => {
  const { nombre, foto, video, poster } = item;

  const div = document.createElement('div');
  div.classList.add('nominado');
  div.dataset.nombre = nombre;

  const media = video
    ? `<video ${poster ? `poster="${poster}"` : ""} src="${video}" muted playsinline></video>`
    : `<img src="${foto || 'fotos/default-user.png'}" alt="${nombre}">`;

  div.innerHTML = `${media}<span>${nombre}</span>`;
  contenedor.appendChild(div);
});

// engancha los v√≠deos de este contenedor al lightbox
wireLightboxForVideos(contenedor);

function openVideoLightbox(src, poster) {
  const modal = document.getElementById('videoLightbox');
  const v = document.getElementById('lightboxVideo');
  if (!modal || !v) return;

  v.src = src;
  if (poster) v.poster = poster; else v.removeAttribute('poster');

  modal.hidden = false;
  document.body.style.overflow = 'hidden';

  v.play().catch(() => {});

}

function closeVideoLightbox() {
  const modal = document.getElementById('videoLightbox');
  const v = document.getElementById('lightboxVideo');
  if (!modal || !v) return;

  try { v.pause(); } catch {}
  v.removeAttribute('src');
  v.load();

  modal.hidden = true;
  document.body.style.overflow = '';
  if (document.fullscreenElement && document.exitFullscreen) {
    document.exitFullscreen().catch(()=>{});
  }
}

// listeners del modal (clic en fondo, bot√≥n cerrar, ESC)
(() => {
  const modal = document.getElementById('videoLightbox');
  if (!modal) return;
  modal.addEventListener('click', (e) => {
    if (e.target.id === 'videoLightbox') closeVideoLightbox();
  });
  const btn = modal.querySelector('.video-modal__close');
  if (btn) btn.addEventListener('click', closeVideoLightbox);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.hidden) closeVideoLightbox();
  });
})();

// conectar v√≠deos de las tarjetas con el lightbox
function wireLightboxForVideos(scope = document) {
  // V√≠deos en peque√±o, con controles nativos
  scope.querySelectorAll('.grid-nominados .nominado video').forEach(v => {
    v.controls = true;
    v.muted = true;
    v.playsInline = true;                     // iOS/Android inline
    v.setAttribute('playsinline', '');        // iOS
    v.setAttribute('webkit-playsinline', ''); // iOS Safari antiguo
    v.setAttribute('preload', 'metadata');    // ahorra datos en m√≥vil
  });

  // Bot√≥n flotante "ver en grande" (abre tu lightbox, NO fullscreen)
  scope.querySelectorAll('.grid-nominados .nominado').forEach(card => {
    const v = card.querySelector('video');
    if (!v) return;
    if (card.querySelector('.btn-expand')) return;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn-expand';
    btn.title = 'Ver en grande';
    btn.setAttribute('aria-label', 'Ver en grande');
    btn.textContent = '‚§¢';

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      openVideoLightbox(v.currentSrc || v.src, v.getAttribute('poster'));
    });

    card.appendChild(btn);
  });
}



  // 3) Selecci√≥n (con m√°ximo por categor√≠a si lo definiste)
  const maxSeleccion = MAX_SELECCION_POR_CATEGORIA[categoriaNombre] ?? 3;

  contenedor.querySelectorAll('.nominado').forEach(item => {
    item.addEventListener('click', () => {
      const nombre = item.dataset.nombre;
      if (item.classList.contains('selected')) {
        item.classList.remove('selected');
        nominacionesPorCategoria[categoriaNombre] =
          nominacionesPorCategoria[categoriaNombre].filter(n => n !== nombre);
      } else {
        if (nominacionesPorCategoria[categoriaNombre].length >= maxSeleccion) {
          alert(`Solo puedes seleccionar ${maxSeleccion} nominados en esta categor√≠a.`);
          return;
        }
        item.classList.add('selected');
        nominacionesPorCategoria[categoriaNombre].push(nombre);
      }
    });
  });
}

// ===== LOTES DE CATEGOR√çAS (6 lotes x 5 categor√≠as) =====

// LOTE 1 (inicial)
const LOTE_1 = [
  "Viajero/a del a√±o",
  "Loco/a del a√±o",
  "Competitivo/a del a√±o",
  "Guarrete del a√±o",
  "Papi/Mami del A√±o"
];

// LOTE 2
const LOTE_2 = [
  "Meme del a√±o",
  "Brainhot del a√±o",
  "Correon del a√±o",
  "Trio del a√±o",
  "Soltero del a√±o"
];

// LOTE 3
const LOTE_3 = [
  "Fiestero/a del a√±o",
  "El que mejor viste del a√±o",
  "Borracho del a√±o",
  "Mejor Personaje fuera de JyP del a√±o",
  "Peor momento del a√±o"
];

// LOTE 4
const LOTE_4 = [
  "Mensaje del a√±o",
  "Mote del a√±o",
  "Palabra/Frase del a√±o",
  "Objeto del a√±o",
  "Baile del a√±o"
];

// LOTE 5
const LOTE_5 = [
  "Autistada del a√±o",
  "Fail del a√±o",
  "Broma del a√±o",
  "Foto del a√±o",
  "Video del a√±o"
];

// LOTE 6
const LOTE_6 = [
  "Fiesta del a√±o",
  "Mejor momento del a√±o",
  "Revelaci√≥n del a√±o",
  "Decepci√≥n del a√±o",
  "MVP del a√±o" 
];

// Junta todos los lotes
const LOTES = [LOTE_1, LOTE_2, LOTE_3, LOTE_4, LOTE_5, LOTE_6];

// üëá control del lote activo (1..6).
//    Cambia este n√∫mero cuando ‚Äúpubliques‚Äù el siguiente lote.
//    ESTA ES LA LINEA QUE HAY QUE CAMBIAR 
const LOTE_ACTIVO = 4;

// (Opcional) permite probar por URL: ?lote=3
function getLoteFromQuery() {
  const n = Number(new URLSearchParams(location.search).get('lote'));
  return Number.isInteger(n) && n >= 1 && n <= LOTES.length ? n : null;
}

// Crea un bloque H2 + P + grid para una categor√≠a y lo inserta antes del bot√≥n
function addCategoriaBlock(titulo, indice) {
  const wrap = document.getElementById('nominadosWrapper'); // <- USAR WRAPPER
  if (!wrap) return;

  const h2 = document.createElement('h2');
  h2.textContent = titulo;

  const max = MAX_SELECCION_POR_CATEGORIA[titulo] ?? 3;
  const p = document.createElement('p');
  p.innerHTML = `Selecciona hasta <strong>${max}</strong> candidatos.`;

  const grid = document.createElement('div');
  grid.id = `lista-nominados-dyn-${indice}`;
  grid.className = 'grid-nominados';

  wrap.appendChild(h2);
  wrap.appendChild(p);
  wrap.appendChild(grid);

  crearApartadoNominaciones(grid.id, titulo);
}

function limpiarNominadosDinamicos() {
  const wrap = document.getElementById('nominadosWrapper');
  if (!wrap) return;
  wrap.innerHTML = '';  // <- limpia TODO el wrapper de una
}

function insertarSeparador(texto) {
  const wrap = document.getElementById('nominadosWrapper');
  if (!wrap) return;
  const sep = document.createElement('div');
  sep.className = 'lote-separador';
  sep.textContent = texto;
  wrap.appendChild(sep);
}

function renderNominadosPorLotes() {
  const cont = document.getElementById('votacion-nominados');

  // 1) decide lote activo (query param tiene prioridad al probar)
  let activo = getLoteFromQuery() ?? LOTE_ACTIVO;

  // 2) limpia lo din√°mico
  limpiarNominadosDinamicos();

  // 3) pinta SOLO el lote activo
  const lote = LOTES[activo - 1] || [];
  lote.forEach((titulo, i) => addCategoriaBlock(titulo, i));

  // (opcional) mensaje si no es el √∫ltimo
  if (activo < LOTES.length) {
    insertarSeparador(`üîí Pr√≥ximamente: Lote ${activo + 1}`);
  }

  // 4) re-aplicar cabeceras con imagen en cada render
  const section = document.getElementById('votacion-nominados');
  delete section.dataset.headersEnhanced; // para que no ‚Äúrecuerde‚Äù la marca
}


async function yaHaEnviadoNominaciones(usuario) {
  if (!usuario) return false;
  const ciclo = await getCicloActual();

  // Firestore: ¬øya envi√≥ en este ciclo?
  const q = query(
    collection(db, "nominaciones"),
    where("usuario", "==", usuario),
    where("ciclo", "==", ciclo)
  );
  const snap = await getDocs(q);
  if (!snap.empty) return true;

  // Local (opcional) por usuario+ciclo
  return localStorage.getItem(`nominacionesEnviadas_${usuario}_${ciclo}`) === "true";
}

async function marcarEnviadoLocal(usuario) {
  if (!usuario) return;
  const ciclo = await getCicloActual();
  localStorage.setItem(`nominacionesEnviadas_${usuario}_${ciclo}`, "true");
}

// ---------- Bot√≥n Enviar todas ----------
const btnEnviarTodas = document.getElementById('enviarTodasNominaciones');

// por si el bot√≥n ya existe ahora
if (btnEnviarTodas && !btnEnviarTodas.dataset.bound) {
  btnEnviarTodas.dataset.bound = "1";
  btnEnviarTodas.addEventListener('click', onEnviarTodasNominaciones);
}



let enviandoNominaciones = false;

async function onEnviarTodasNominaciones(e) {
  e.preventDefault();

  if (enviandoNominaciones) return;       // ‚õî evita reentrada
  enviandoNominaciones = true;

  const btn = document.getElementById('enviarTodasNominaciones');
  if (btn) {
    btn.disabled = true;
    btn.innerText = "Enviando‚Ä¶";
  }

  try {
    const usuario = localStorage.getItem('usuarioLogueado');
    if (!usuario) { 
      alert("Debes iniciar sesi√≥n para enviar nominaciones."); 
      mostrarSeccion('login'); 
      return;
    }

    // Validaci√≥n como ya tienes‚Ä¶
    for (const categoria in nominacionesPorCategoria) {
      if (nominacionesPorCategoria[categoria].length === 0) {
        alert(`Debes seleccionar al menos un nominado en la categor√≠a: ${categoria}`);
        return;
      }
    }
const ciclo = await getCicloActual();

// ‚úÖ Escritura segura con ID saneado (sin "/")
for (const categoria in nominacionesPorCategoria) {
  const id = `${safeIdPart(usuario)}__${safeIdPart(categoria)}__${ciclo}`;
  await setDoc(doc(db, "nominaciones", id), {
    usuario,                      // guardamos el nombre original tal cual
    categoria,                    // idem
    nominados: nominacionesPorCategoria[categoria],
    ciclo,
    fecha: serverTimestamp()
  });
}



    await marcarEnviadoLocal(usuario);
    if (window.actualizarEstadoBotonNominaciones) {
      await window.actualizarEstadoBotonNominaciones();
    }

    alert("¬°Todas tus nominaciones han sido registradas!");
    document.querySelectorAll('.nominado').forEach(n => n.classList.remove('selected'));
    for (const c in nominacionesPorCategoria) nominacionesPorCategoria[c] = [];

  } catch (e) {
    console.error("Error guardando nominaciones:", e);
    alert("Hubo un error al guardar tus nominaciones.");
  } finally {
    enviandoNominaciones = false;

    }
  }



async function actualizarEstadoBotonNominaciones() {
  const usuario = localStorage.getItem('usuarioLogueado');
  const btn = document.getElementById('enviarTodasNominaciones');
  if (!btn) return;

  if (!usuario) {
    btn.disabled = true;
    btn.innerText = "Inicia sesi√≥n para nominar";
    return;
  }

  const enviado = await yaHaEnviadoNominaciones(usuario);
  btn.disabled = enviado;
  btn.innerText = enviado
    ? "Ya has enviado tus nominaciones"
    : "Enviar todas las nominaciones";
}

// üëá importante: exponerla en el global para poder llamarla desde cualquier sitio
window.actualizarEstadoBotonNominaciones = actualizarEstadoBotonNominaciones;


    // =========================
    // RESULTADOS CON LOGIN ADMIN
    // =========================
// =========================
// LOGIN
// =========================
document.getElementById("btnLogin").addEventListener("click", async () => {
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();

  if (usuariosPermitidos[user] && usuariosPermitidos[user].pass === pass) {
    localStorage.setItem("usuarioLogueado", user);
    mostrarPerfil(user);
    controlarAccesoResultados();

    // Oculta login y muestra app
    document.getElementById("login").style.display = "none";
    document.getElementById("appContent").style.display = "block";

    // Arranca en inicio
    mostrarSeccion("inicio");

    // üëá Refresca estado del bot√≥n de nominaciones ya con usuario en localStorage
    if (window.actualizarEstadoBotonNominaciones) {
      await window.actualizarEstadoBotonNominaciones();
    }
  } else {
    document.getElementById("loginError").style.display = "block";
  }
});

   async function cargarResultados() {
  const contenedor = document.getElementById('tabla-resultados');
  contenedor.innerHTML = "<p>Cargando resultados...</p>";

  try {
    let ciclo = await getCicloActual();

    // 1) Intentamos ciclo actual
    let qActual = query(collection(db, "nominaciones"), where("ciclo", "==", ciclo));
    let snapshot = await getDocs(qActual);

    // 2) Si no hay datos en el actual, probamos con el anterior
    if (snapshot.empty && ciclo > 1) {
      const qPrev = query(collection(db, "nominaciones"), where("ciclo", "==", ciclo - 1));
      const snapPrev = await getDocs(qPrev);
      if (!snapPrev.empty) {
        ciclo = ciclo - 1;
        snapshot = snapPrev;
      }
    }

    // 3) Si sigue vac√≠o, mostramos mensaje
    if (snapshot.empty) {
      contenedor.innerHTML = "<p>No hay resultados a√∫n.</p>";
      return;
    }

    // ---- Render resultados ----
    const conteo = {};
    const votantes = new Set();

    snapshot.forEach(d => {
      const data = d.data();
      const categoria = data.categoria || "Sin categor√≠a";
      if (data.usuario) votantes.add(data.usuario);
      if (!conteo[categoria]) conteo[categoria] = {};
      (data.nominados || []).forEach(nombre => {
        conteo[categoria][nombre] = (conteo[categoria][nombre] || 0) + 1;
      });
    });

    contenedor.innerHTML = "";

    // Indicador de qu√© ciclo se muestra
    const badge = document.createElement('p');
    badge.style.opacity = "0.8";
    badge.innerHTML = `<em>Mostrando resultados del ciclo ${ciclo}</em>`;
    contenedor.appendChild(badge);

    if (votantes.size > 0) {
      const bloqueVotantes = document.createElement('div');
      bloqueVotantes.innerHTML = `
        <h4>Personas que han votado:</h4>
        <p>${Array.from(votantes).join(', ')}</p>
      `;
      contenedor.appendChild(bloqueVotantes);
    }

    for (const categoria in conteo) {
      const bloque = document.createElement('div');
      bloque.innerHTML = `<h4>${categoria}</h4>`;
      const lista = document.createElement('ul');
      Object.entries(conteo[categoria])
        .sort((a,b) => b[1]-a[1])
        .forEach(([nombre, votos]) => {
          const li = document.createElement('li');
          li.textContent = `${nombre}: ${votos} votos`;
          lista.appendChild(li);
        });
      bloque.appendChild(lista);
      contenedor.appendChild(bloque);
    }

  } catch (e) {
    console.error("Error cargando resultados:", e);
    contenedor.innerHTML = "<p>Error al cargar resultados.</p>";
  }
}



    // Opcional: arrancar en Inicio
    mostrarSeccion('inicio');


// Funci√≥n gen√©rica para borrar todos los documentos de una colecci√≥n
async function borrarColeccion(nombreColeccion) {
  try {
    const q = query(collection(db, nombreColeccion));
    const snapshot = await getDocs(q);
    const total = snapshot.size;
    if (total === 0) {
      alert(`No hay documentos en la colecci√≥n "${nombreColeccion}".`);
      return;
    }
    if (!confirm(`¬øSeguro que quieres borrar ${total} documentos de "${nombreColeccion}"?`)) return;

    for (const documento of snapshot.docs) {
      await deleteDoc(doc(db, nombreColeccion, documento.id));
    }
    alert(`Se han borrado ${total} documentos de "${nombreColeccion}".`);
    cargarResultados(); // refrescar resultados
  } catch (e) {
    console.error(`Error borrando ${nombreColeccion}:`, e);
    alert(`Error al borrar documentos de "${nombreColeccion}".`);
  }
}

document.getElementById('restaurarVotaciones').addEventListener('click', async () => {
  if (!confirm("Iniciar una NUEVA ronda de votaciones. Los registros anteriores se conservar√°n. ¬øContinuar?")) return;

  try {
    const nuevoCiclo = await aumentarCiclo();  // solo subimos el ciclo
    alert(`¬°Listo! Se ha iniciado el ciclo ${nuevoCiclo}. Todos pueden volver a votar.`);

    // ‚õî NO llamamos a cargarResultados() para no vaciar la vista actual
    if (window.actualizarEstadoBotonNominaciones) await window.actualizarEstadoBotonNominaciones();
  } catch (e) {
    console.error(e);
    alert("No se pudo iniciar la nueva ronda.");
  }
});





// Modal de categor√≠as
const modalCategoria = document.getElementById("modalCategoria");
const modalImgCat = document.getElementById("modalImagenCategoria");
const modalDescCat = document.getElementById("modalDescripcionCategoria");
const cerrarCat = modalCategoria.querySelector(".cerrar");

// Abrir modal al hacer clic en una categor√≠a
document.querySelectorAll(".categoria").forEach(cat => {
  cat.addEventListener("click", () => {
    modalImgCat.src = cat.querySelector("img").src;
    modalDescCat.textContent = cat.dataset.descripcion;
    modalCategoria.style.display = "block";
  });
});

// Cerrar modal
cerrarCat.addEventListener("click", () => {
  modalCategoria.style.display = "none";
});
window.addEventListener("click", (e) => {
  if (e.target === modalCategoria) {
    modalCategoria.style.display = "none";
  }
});


  </script>

</script> 
<script>
    const descripciones = {
      "Asieras": "ASIER, m√°s conocido como chichotas,Cedido de balnomano alarcos Ciudad Real e Hijo de Peter el batallas. es el due√±o del famoso campo San Bartolom√©, le gusta mucho drogarse y emborracharse, por lo menos no fuma porros ",
      "Rulillas": "RULAS es el mayor amante de las tortillas y los nuggets, tiene a chicote a su servicio para hacerle cualquier tipo de macarron con tomatico, le gusta mucho que le vomiten en la silla, es un maltratador de tortugas profesional, una vez encerr√≥ a su tortuga en un cubo de basura durante 21 a√±os, es un mitico personaje de este grupo de subnormales que tiene una de las frases mas miticas de Operacion Triunfo POSSSS AVEEERRRRR",
      "Darawayas": "DARIO es el fan n√∫mero uno de la pam veraniega, junto con el peque√±o kastorcin tienen un negocio llamado socios.basura, el supuesto camara del grupo que el a√±o pasado nos deleit√≥ con miticas escenas pornograficas de la gala, es un amante del fortnite y un guarro que se tira a todas las peruanas que pilla ",
      "Ivanpechotes": "IVANPE es conocido como el reh√©n de Jugui Qui Jugui, si juegas con el al futbol ten en cuenta que tienes que correr mas que un puto Velocirraptor en plena era del Jurasico porque la gacela Thomphson no va a dejar a nadie escapar, baila como un abuelo senil de 347 a√±os y aun no sabemos quien es su amor verdadero si la francesa esa o Lamine Yamal ",
      "DaniGG": " DANI es un militar casposo siempre en el calabozo, no sale nunca de madrid por ver a su querida esposa es mas guarro que un satisfyer de segunda mano, y hablando de manos a saber cuantas le habran metido por el culo... Creemos que seria capaz de vender a toda su familia y amigos por un saludo del Rey Felipe",
      "Lusilu": "LUC√çA tambien apodada como Lusilu o como la famosa novia de Sergio Ramos, aunque Alvaro de Luna tampoco se queda atras, estudia ADE(Asociacion De Esquizofrenicos) no le pega nada, como diria su esposo con mas de 3000 a√±os las mujeres a la cocina!",
      "Almansa": "INES La de los caminos, se dedica a ir poniendo grano a grano e ir haciendo caminos en ciudad real, ahora mismo esta yendo a Lituania en uno de sus caminos magicos, siempre pone su casa para hacer las reuniones auque el pobre Mart√≠n la vaya a denunciar ella nunca nos denegara√° la entrada, no sabemos que vamos a hacer los sabados resacosos Almansunsin",
      "Robertuki": "ROBER el tio mas pesado que vas a ver en la historia, en vez de darte la mano al verte como har√≠a una persona normal coje y te mete una hostia, pero y este tio?, aun no sabemos si viene del sur de Espa√±a o de la profunda Antartida lo que si sabemos es que es el fundador de obesos sin fronteras, aunque sea Don Rosalio Parrales y trabaje mas que un negro en el Hospital de la estaci√≥n de Le√≥n, lo odiamos mucho.",
      "To√±aco": "MARCO el famoso jugador cedido del Caserio que al final se fue al Alarcos y un negro que acababa de salir de la selva tropical lo echo sin ning√∫n tipo de remordimiento, por eso volvio a su equipo Caserio Colesterol, hizo la aparicion estelar en la famosa fiesta como DjPoyocu pero hizo bomba de humo, aun lo estan buscando en todo el norte de Ciudad Real, cuenta la leyenda que el tequifresi lo mat√≥",
      "Manolo": "MANU es conocido por no bajar nunca, pr√°cticamente no queda con el grupo y casi nunca aparece, lo que ya se ha convertido en parte de su leyenda entre los amigos.",
      "Kastor": "MARIO es un apasionado del f√∫tbol y del Real Madrid, siempre al d√≠a con los partidos y noticias. Es muy estudioso y, entre amigos, se comenta que tiene un parecido curioso a un castor.",
      "Maria": "MAR√çA se fue de Erasmus a Francia, viviendo nuevas experiencias y culturas. Estudia Letras y es la orgullosa novia de la famosa Jugui Qui Jugui, lo que la hace a√∫n m√°s conocida y querida en el grupo.",
      "Gamepro": "GAMEPRO tiene una debilidad por Albacete, su ciudad favorita, que visita siempre que puede. Trabaja en Popeyes y, adem√°s, es el orgulloso novio de Iceman, lo que lo hace todav√≠a m√°s querido en el grupo.",
      "El Enano": "FERVICO es el enano del grupo, apodo que lleva con humor y que ya es parte de su identidad entre amigos. Todos recuerdan que solo ha tocado a una mujer en su vida (¬°y vaya tetas!), detalle que se comenta con frecuencia. Aun as√≠, sigue siendo virgen, lo que suma a las bromas y an√©cdotas que lo rodean.",
      "Poru": "PORU es un chico al que le encantan las cafeteras, aunque siempre se nos olvida y por eso le decimos ‚ÄúForgotten‚Äù. Es de los que tienen su propio apodo ya ganado en el grupo. Adem√°s, no hay duda de que su cantante favorito es Trueno, lo menciona cada vez que puede.",
      "Ikardo": "IKER es apodado el chino del grupo, siempre con ganas de zorrear y pasar un buen rato. Su sello personal son los pantalones de Bob Esponja, que lleva puestos pr√°cticamente siempre.",
      "Fermoriv": "FERMORIV es un amante del lanzamiento de quesos, una de esas pasiones raras que ya todos en el grupo reconocen. Siempre aparece de fiesta en fiesta y, sin duda, se convierte en el alma del grupo con su energ√≠a y buen humor.",
      "Lab el Viejo": "LABRADA es el viejo del grupo siempre buscando lo m√°s econ√≥micamente rentable en cualquier tema de finanzas. Adem√°s, no tiene filtro y es m√°s guarro que un cerdo, lo que lo hace memorable y √∫nico entre todos.."
    };
    
    const modal = document.getElementById("modalParticipante");
const modalImg = document.getElementById("modalImagen");
const modalDescripcion = document.getElementById("modalDescripcion");
const spanCerrar = document.querySelector(".cerrar");

document.querySelectorAll(".participante").forEach(part => {
  part.addEventListener("click", () => {
    const img = part.querySelector("img");
    const nombre = part.querySelector("h3").innerText.trim();
    modalImg.src = img.src;
    modalDescripcion.innerText = descripciones[nombre] || "Sin descripci√≥n disponible.";
    modal.style.display = "block";
  });
});

spanCerrar.onclick = () => modal.style.display = "none";
window.onclick = e => { if (e.target == modal) modal.style.display = "none"; }
</script>
    